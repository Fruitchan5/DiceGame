<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Web3 éª°å® - å¹¸è¿åŒºé—´</title>
    <script src="./ethers.js"></script>
    <style>
        /* --- 1. æ•´ä½“è‰²è°ƒï¼šæ·¡é»„è‰² --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FFFBE6; /* æ·¡å¥¶æ²¹é»„èƒŒæ™¯ */
            color: #5D4037; /* æ·±æ£•è‰²æ–‡å­—ï¼Œå¯¹æ¯”åº¦å¥½ */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            
        }

        h1 { color: #Fbc02d; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); margin-bottom: 5px; }
        p.subtitle { color: #8d6e63; font-size: 0.9em; margin-bottom: 30px; }

        /* --- 2. æ¸¸æˆä¸»å¡ç‰‡ --- */
        .game-card {
            background: #ffffff;
            width: 100%;
            max-width: 480px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(251, 192, 45, 0.2); /* é»„è‰²å…‰æ™•é˜´å½± */
            text-align: center;
            border: 2px solid #FFF9C4;
        }

        /* --- 3. é€æ˜ç½©å­ä¸éª°å­ --- */
        .cover-container {
            position: relative;
            width: 300px;
            height: 180px;
            margin: 0 auto 20px auto;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            perspective: 1000px;
        }

        /* é€æ˜ç½©å­ CSS */
        .glass-cover {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 260px;
            height: 140px;
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-bottom: none;
            border-radius: 140px 140px 0 0; /* åŠåœ†æ‹±å½¢ */
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.9), 0 5px 15px rgba(0,0,0,0.05);
            z-index: 10;
            pointer-events: none;
        }

        /* éª°å­å®¹å™¨ */
        .dice-row {
            display: flex;
            gap: 20px;
            padding-bottom: 30px;
            z-index: 5;
        }

        .dice {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            color: #d32f2f; /* éª°å­ç‚¹æ•°çº¢è‰² */
            font-weight: bold;
            border: 1px solid #eee;
            transition: transform 0.1s;
        }

        /* é«˜é€Ÿæ—‹è½¬åŠ¨ç”» */
        @keyframes shakeDice {
            0% { transform: rotate(0deg) translate(0, 0); }
            25% { transform: rotate(15deg) translate(5px, -10px); }
            50% { transform: rotate(-10deg) translate(-5px, 5px); }
            75% { transform: rotate(5deg) translate(5px, 5px); }
            100% { transform: rotate(0deg) translate(0, 0); }
        }
        .shaking {
            animation: shakeDice 0.1s infinite; /* 0.1ç§’å¾ªç¯ä¸€æ¬¡ï¼Œçœ‹èµ·æ¥éå¸¸å¿« */
        }

        /* --- 4. åŒæ»‘æ†åŒºé—´é€‰æ‹© --- */
        .slider-container {
            position: relative;
            height: 60px;
            margin-top: 20px;
            background: #FFFDE7;
            border-radius: 10px;
            padding: 15px;
        }
        
        .range-display {
            font-weight: bold;
            color: #F57F17;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        /* ä¸¤ä¸ªæ»‘å—é‡å åœ¨ä¸€èµ· */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            position: absolute;
            left: 0;
            background: transparent;
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€ï¼Œä¸ºäº†è®©ä¸¤ä¸ªæ»‘å—èƒ½åŒæ—¶æ“ä½œ */
        }
        
        /* å¯ç”¨æ»‘å—æ‹‡æŒ‡çš„é¼ æ ‡äº‹ä»¶ */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            pointer-events: all;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #Fbc02d;
            cursor: pointer;
            margin-top: -10px;
            position: relative;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* æ»‘å—è½¨é“èƒŒæ™¯ï¼ˆåªæ˜¾ç¤ºä¸€ä¸ªå³å¯ï¼‰ */
        .slider-track-bg {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            position: absolute;
            top: 45px;
            left: 0;
            z-index: 1;
        }

        /* --- 5. åº•éƒ¨æ•°æ®ä¸æŒ‰é’® --- */
        .stats-row {
            display: flex;
            justify-content: space-between;
            background: #FFF9C4;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.95em;
        }

        button#playBtn {
            background: linear-gradient(135deg, #Fbc02d 0%, #F57F17 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(249, 168, 37, 0.4);
            transition: transform 0.2s;
        }
        button#playBtn:active { transform: scale(0.98); }
        button#playBtn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        .status-msg { height: 30px; margin-top: 15px; font-weight: bold; }
        .win { color: #2E7D32; }
        .lose { color: #C62828; }

    </style>
</head>
<body>

    <h1>ğŸ² å¹¸è¿åŒºé—´éª°å­</h1>
    <p class="subtitle">åŒºå—é“¾å…¬å¹³åšå½© Â· è‡ªå®šä¹‰èµ”ç‡</p>

    <div class="game-card">
        <button id="connectBtn" onclick="connectWallet()" style="background:white; border:1px solid #Fbc02d; color:#Fbc02d; padding:8px 20px; border-radius:20px; cursor:pointer; margin-bottom:15px; font-size:0.9em;">
            ğŸ”— è¿æ¥é’±åŒ… (Sepolia)
        </button>

        <div class="cover-container">
            <div class="glass-cover"></div> <div class="dice-row">
                <div class="dice" id="d1">1</div>
                <div class="dice" id="d2">2</div>
                <div class="dice" id="d3">3</div>
            </div>
        </div>

        <div class="slider-container">
            <div class="range-display">
                ç›®æ ‡æ€»å’Œ: <span id="rangeVal">10 - 15</span>
            </div>
            
            <div style="position: relative; height: 30px; margin: 0 10px;">
                <div class="slider-track-bg"></div>
                <input type="range" id="minRange" min="3" max="18" value="10" step="1" oninput="updateRange('min')">
                <input type="range" id="maxRange" min="3" max="18" value="15" step="1" oninput="updateRange('max')">
            </div>
        </div>

        <div class="stats-row">
            <div>ä¸‹æ³¨: <input type="number" id="betAmount" value="0.001" step="0.001" style="width:60px; border:1px solid #ddd; border-radius:4px; padding:2px;"> ETH</div>
            <div>èƒœç‡: <span id="probDisplay">--</span>%</div>
            <div>èµ”ç‡: <span id="oddsDisplay">--</span>x</div>
        </div>

        <button id="playBtn" onclick="play()" disabled>å¼€å§‹æ·éª°å­ (Spin)</button>
        
        <div id="status" class="status-msg">è¯·å…ˆè¿æ¥é’±åŒ…</div>
    </div>

<script>
    // ================= é…ç½®åŒº =================
    // âš ï¸âš ï¸âš ï¸ æŠŠè¿™é‡Œæ¢æˆä½ éƒ¨ç½²å¥½çš„åˆçº¦åœ°å€ï¼ï¼ï¼
    const CONTRACT_ADDRESS = "0x364c489cACe65149ecAEd62801Dc7Ec5F31D565a"; 
    // =========================================

    const ABI = [
        "function roll(uint8 minSum, uint8 maxSum) public payable",
        "event GameResult(address player, uint256 bet, uint8 min, uint8 max, uint8 d1, uint8 d2, uint8 d3, uint8 sum, uint256 payout)"
    ];
    // 3ä¸ªéª°å­å’Œçš„é¢‘æ•°è¡¨ (3-18)
    const FREQUENCIES = [0,0,0,1,3,6,10,15,21,25,27,27,25,21,15,10,6,3,1];
    let contract, signer;

    // --- 1. åŒæ»‘æ†é€»è¾‘ ---
    function updateRange(source) {
        let minInput = document.getElementById('minRange');
        let maxInput = document.getElementById('maxRange');
        let minVal = parseInt(minInput.value);
        let maxVal = parseInt(maxInput.value);

        // ç¡®ä¿ min ä¸ä¼šè¶…è¿‡ max
        if (minVal > maxVal) {
            if (source === 'min') { maxInput.value = minVal; } 
            else { minInput.value = maxVal; }
        }

        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('rangeVal').innerText = `${minInput.value} - ${maxInput.value}`;
        calculateOdds(); // é‡æ–°è®¡ç®—èµ”ç‡
    }

    // --- 2. èµ”ç‡è®¡ç®— ---
    function calculateOdds() {
        let min = parseInt(document.getElementById('minRange').value);
        let max = parseInt(document.getElementById('maxRange').value);
        
        let winningCombos = 0;
        for(let i=min; i<=max; i++) winningCombos += FREQUENCIES[i];
        
        // é˜²æ­¢é™¤0é”™è¯¯
        if(winningCombos === 0) winningCombos = 1;

        let prob = (winningCombos / 216) * 100;
        let payout = (216 * 0.98 / winningCombos);

        document.getElementById('probDisplay').innerText = prob.toFixed(1);
        document.getElementById('oddsDisplay').innerText = payout.toFixed(2);
    }

    // --- 3. é’±åŒ…è¿æ¥ ---
    async function connectWallet() {
        if (!window.ethereum) return alert("è¯·å®‰è£… MetaMask");
        try {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            
            const addr = await signer.getAddress();
            document.getElementById('connectBtn').innerText = "âœ… " + addr.substring(0,6) + "...";
            document.getElementById('playBtn').disabled = false;
            document.getElementById('status').innerText = "å‡†å¤‡å°±ç»ªï¼Œç¥ä½ å¥½è¿ï¼";
            
            calculateOdds();
            listenEvents(); // å¯åŠ¨ç›‘å¬
        } catch (e) { 
            console.error(e);
            document.getElementById('status').innerText = "è¿æ¥å¤±è´¥";
        }
    }

    // --- 4. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ (å¸¦åŠ¨ç”») ---
    async function play() {
        const min = document.getElementById('minRange').value;
        const max = document.getElementById('maxRange').value;
        const bet = document.getElementById('betAmount').value;

        // A. ç«‹å³å¼€å§‹åŠ¨ç”» (é«˜é€Ÿæ—‹è½¬)
        startAnimation(); 
        document.getElementById('playBtn').disabled = true;
        document.getElementById('status').innerText = "è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...";

        try {
            // B. å‘èµ·äº¤æ˜“
            const tx = await contract.roll(min, max, { value: ethers.utils.parseEther(bet) });
            
            document.getElementById('status').innerText = "â›“ï¸ äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç»“æœ (è¿™å¯èƒ½éœ€è¦15ç§’)...";
            
            // C. ç­‰å¾…ä¸Šé“¾ç»“æœ
            // æ³¨æ„ï¼šåŠ¨ç”»ä¼šä¸€ç›´è½¬ï¼Œç›´åˆ°ç›‘å¬åˆ°é“¾ä¸Šçš„ Result äº‹ä»¶æ‰åœæ­¢
            await tx.wait(); 
            
        } catch (err) {
            console.error(err);
            stopAnimation(); // å¤±è´¥ä¹Ÿè¦åœæ­¢åŠ¨ç”»
            document.getElementById('status').innerText = "âŒ äº¤æ˜“å–æ¶ˆæˆ–å¤±è´¥";
            document.getElementById('playBtn').disabled = false;
        }
    }

    // --- 5. åŠ¨ç”»æ§åˆ¶ ---
    let animInterval;
    function startAnimation() {
        const dices = document.querySelectorAll('.dice');
        dices.forEach(d => d.classList.add('shaking')); // æ·»åŠ CSSæŠ–åŠ¨ç±»
        
        // æ¯0.1ç§’éšæœºå˜æ•°å­—ï¼Œå¢åŠ è§†è§‰æ··ä¹±æ„Ÿ
        animInterval = setInterval(() => {
            dices.forEach(d => {
                d.innerText = Math.floor(Math.random() * 6) + 1;
            });
        }, 80);
    }

    function stopAnimation(d1Val, d2Val, d3Val) {
        clearInterval(animInterval);
        const dices = document.querySelectorAll('.dice');
        dices.forEach(d => d.classList.remove('shaking')); // ç§»é™¤æŠ–åŠ¨
        
        // å¦‚æœæœ‰çœŸå®ç»“æœï¼Œæ˜¾ç¤ºçœŸå®ç»“æœï¼›å¦åˆ™æ˜¾ç¤ºé»˜è®¤
        if(d1Val) {
            document.getElementById('d1').innerText = d1Val;
            document.getElementById('d2').innerText = d2Val;
            document.getElementById('d3').innerText = d3Val;
        }
    }

    // --- 6. ç›‘å¬é“¾ä¸Šç»“æœ ---
    function listenEvents() {
        contract.on("GameResult", (player, bet, min, max, d1, d2, d3, sum, payout) => {
            signer.getAddress().then(myAddr => {
                // ç¡®ä¿åªå¤„ç†è‡ªå·±çš„äº‹ä»¶
                if(player === myAddr) {
                    // å»¶è¿Ÿ1ç§’åœæ­¢åŠ¨ç”»ï¼Œè®©ç”¨æˆ·çœ‹æ¸…æ¥š
                    setTimeout(() => {
                        stopAnimation(d1, d2, d3); // åœæ­¢åŠ¨ç”»å¹¶æ˜¾ç¤ºçœŸå€¼
                        
                        const profit = ethers.utils.formatEther(payout);
                        const statusDiv = document.getElementById('status');
                        
                        if (parseFloat(profit) > 0) {
                            statusDiv.innerHTML = `<span class="win">ğŸ‰ èµ¢äº†ï¼ç‚¹æ•° ${d1}+${d2}+${d3}=${sum}ï¼Œèµ¢å¾— ${profit} ETH</span>`;
                        } else {
                            statusDiv.innerHTML = `<span class="lose">ğŸ˜­ è¾“äº†... ç‚¹æ•° ${sum} ä¸åœ¨ ${min}-${max} ä¹‹é—´</span>`;
                        }
                        document.getElementById('playBtn').disabled = false;
                    }, 1000); // è¿™é‡Œçš„1000msæ˜¯ä¸ºäº†ç¬¦åˆä½ è¯´çš„â€œæ—‹è½¬1sååœæ­¢â€çš„æ„Ÿè§‰
                }
            });
        });
    }
    
    // åˆå§‹åŒ–æ˜¾ç¤º
    calculateOdds();
</script>
</body>
</html>